stress = meta$stress,
trymax = meta$trymax,
points = matrix_payload(meta$points),
species = matrix_payload(meta$species)
),
rda = list(
eigenvalues = list(
constrained = unname(rda_model$CCA$eig),
unconstrained = unname(rda_model$CA$eig)
),
bases = list(
cca_wa = matrix_payload(rda_model$CCA$wa),
ca_u = matrix_payload(rda_model$CA$u),
cca_v = matrix_payload(rda_model$CCA$v),
ca_v = matrix_payload(rda_model$CA$v)
),
weights = list(
row_sums = unname(rda_model$rowsum),
col_sums = unname(rda_model$colsum)
),
totals = list(
tot_chi = rda_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 3))
)
)
),
cca = list(
eigenvalues = list(
constrained = unname(cca_model$CCA$eig),
unconstrained = unname(cca_model$CA$eig)
),
bases = list(
cca_u = matrix_payload(cca_model$CCA$u),
cca_v = matrix_payload(cca_model$CCA$v),
cca_wa = matrix_payload(cca_model$CCA$wa),
ca_u = matrix_payload(cca_model$CA$u),
ca_v = matrix_payload(cca_model$CA$v)
),
totals = list(
tot_chi = cca_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 3))
)
)
),
pca = list(
sdev = unname(pca_model$sdev),
rotation = matrix_payload(pca_model$rotation),
x = matrix_payload(pca_model$x),
center = unname(pca_model$center),
scale = unname(pca_model$scale)
),
envfit = list(
r = vector_payload(envfit_model$vectors$r),
r2 = vector_payload(envfit_model$vectors$r^2),
pvals = vector_payload(envfit_model$vectors$pvals),
scores = matrix_payload(scores(envfit_model, "vectors"))
),
procrustes = list(
correlation = unname(procrustes_summary$correlation),
ss = unname(procrustes_model$ss),
rotation = matrix_payload(procrustes_model$rotation),
translation = vector_payload(procrustes_model$translation)
)
)
# Dissimilarity & permutation ---------------------------------------------------
vegdist_bray <- vegan::vegdist(varespec, method = "bray")
adonis2_model <- vegan::adonis2(varespec ~ N + P + K + Ca + Mg,
data = varechem, permutations = 199)
anosim_model <- vegan::anosim(vegdist_bray, grouping, permutations = 199)
mrpp_model <- vegan::mrpp(varespec, grouping, permutations = 199)
betadisper_model <- vegan::betadisper(vegdist_bray, grouping, type = "centroid")
permutest_betadisper <- vegan::permutest(betadisper_model, permutations = 199)
mantel_model <- vegan::mantel(vegdist_bray, vegdist(varechem[, env_vars]), permutations = 199)
mantel_partial_model <- vegan::mantel.partial(vegdist_bray, vegdist(varechem[, env_vars]), vegdist(varechem[, env_vars[-1]]), permutations = 199)
protest_model <- vegan::protest(meta$points,
rda_sites_for_procrustes,
permutations = 199)
protest_ss <- as.numeric(protest_model$ss)[1]
protest_correlation <- sqrt(max(0, 1 - protest_ss))
protest_signif <- as.numeric(protest_model$signif)
anova_rda <- stats::anova(rda_model, permutations = 199)
permutest_rda <- vegan::permutest(rda_model, permutations = 199)
permutest_rda_tab <- permutest_rda$tab
if (is.null(permutest_rda_tab) || nrow(permutest_rda_tab) == 0) {
model_row <- data.frame(
Df = permutest_rda$df,
Variance = permutest_rda$tot.chi,
F = permutest_rda$f,
`Pr(>F)` = permutest_rda$signif,
row.names = "Model"
)
residual_row <- NULL
if (!is.null(permutest_rda$df.residual) && length(permutest_rda$df.residual) > 0) {
residual_row <- data.frame(
Df = permutest_rda$df.residual,
Variance = permutest_rda$res.chi,
F = NA_real_,
`Pr(>F)` = NA_real_,
row.names = "Residual"
)
}
permutest_rda_tab <- rbind(model_row, residual_row)
}
# Helper script to export vegan reference values for nuee comparison.
#
# Usage (from repo root in R):
#   source("tests/reference/export_vegan.R")
#
# The script writes a single RDS/JSON pair that captures representative
# outputs for the vegan functions mirrored in nuee. These payloads are
# consumed by the Python diagnostics to assert numerical compatibility.
library(vegan)
library(jsonlite)
setwd("C:/Users/parse01/documents-locaux/GitHub/nuee")
set.seed(123)
data(varespec)
data(varechem)
env_vars <- c("N", "P", "K", "Ca", "Mg")
grouping <- factor(ifelse(varechem$Humdepth > median(varechem$Humdepth),
"High", "Low"),
levels = c("Low", "High"))
matrix_payload <- function(mat) {
if (is.null(mat)) {
return(NULL)
}
m <- as.matrix(mat)
list(
data = unname(m),
rownames = if (!is.null(rownames(m))) as.character(rownames(m)) else NULL,
colnames = if (!is.null(colnames(m))) as.character(colnames(m)) else NULL
)
}
vector_payload <- function(vec) {
if (is.null(vec)) {
return(NULL)
}
vals <- unname(as.numeric(vec))
list(
data = vals,
names = if (!is.null(names(vec))) as.character(names(vec)) else NULL
)
}
dist_payload <- function(d) {
if (is.null(d)) {
return(NULL)
}
list(
data = unname(as.numeric(d)),
size = attr(d, "Size"),
labels = if (!is.null(attr(d, "Labels"))) as.character(attr(d, "Labels")) else NULL,
method = attr(d, "method")
)
}
table_payload <- function(tbl) {
if (is.null(tbl)) {
return(NULL)
}
df <- as.data.frame(tbl)
matrix_payload(df)
}
# Ordination -------------------------------------------------------------------
meta <- vegan::metaMDS(varespec, k = 2, distance = "bray",
trymax = 20, trace = FALSE)
rda_model <- vegan::rda(varespec, varechem[, env_vars])
cca_model <- vegan::cca(varespec, varechem[, env_vars])
pca_model <- stats::prcomp(varespec, center = TRUE, scale. = TRUE)
envfit_model <- vegan::envfit(meta, varechem[, env_vars], permutations = 199)
rda_sites_scaling1 <- scores(rda_model, display = "sites", scaling = 1)
rda_sites_for_procrustes <- rda_sites_scaling1[, seq_len(ncol(meta$points)), drop = FALSE]
procrustes_model <- vegan::procrustes(rda_sites_for_procrustes,
meta$points, symmetric = TRUE)
procrustes_summary <- summary(procrustes_model)
ordination_reference <- list(
metaMDS = list(
stress = meta$stress,
trymax = meta$trymax,
points = matrix_payload(meta$points),
species = matrix_payload(meta$species)
),
rda = list(
eigenvalues = list(
constrained = unname(rda_model$CCA$eig),
unconstrained = unname(rda_model$CA$eig)
),
bases = list(
cca_wa = matrix_payload(rda_model$CCA$wa),
ca_u = matrix_payload(rda_model$CA$u),
cca_v = matrix_payload(rda_model$CCA$v),
ca_v = matrix_payload(rda_model$CA$v)
),
weights = list(
row_sums = unname(rda_model$rowsum),
col_sums = unname(rda_model$colsum)
),
totals = list(
tot_chi = rda_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 3))
)
)
),
cca = list(
eigenvalues = list(
constrained = unname(cca_model$CCA$eig),
unconstrained = unname(cca_model$CA$eig)
),
bases = list(
cca_u = matrix_payload(cca_model$CCA$u),
cca_v = matrix_payload(cca_model$CCA$v),
cca_wa = matrix_payload(cca_model$CCA$wa),
ca_u = matrix_payload(cca_model$CA$u),
ca_v = matrix_payload(cca_model$CA$v)
),
totals = list(
tot_chi = cca_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 3))
)
)
),
pca = list(
sdev = unname(pca_model$sdev),
rotation = matrix_payload(pca_model$rotation),
x = matrix_payload(pca_model$x),
center = unname(pca_model$center),
scale = unname(pca_model$scale)
),
envfit = list(
r = vector_payload(envfit_model$vectors$r),
r2 = vector_payload(envfit_model$vectors$r^2),
pvals = vector_payload(envfit_model$vectors$pvals),
scores = matrix_payload(scores(envfit_model, "vectors"))
),
procrustes = list(
correlation = unname(procrustes_summary$correlation),
ss = unname(procrustes_model$ss),
rotation = matrix_payload(procrustes_model$rotation),
translation = vector_payload(procrustes_model$translation)
)
)
# Dissimilarity & permutation ---------------------------------------------------
vegdist_bray <- vegan::vegdist(varespec, method = "bray")
adonis2_model <- vegan::adonis2(varespec ~ N + P + K + Ca + Mg,
data = varechem, permutations = 199)
anosim_model <- vegan::anosim(vegdist_bray, grouping, permutations = 199)
mrpp_model <- vegan::mrpp(varespec, grouping, permutations = 199)
betadisper_model <- vegan::betadisper(vegdist_bray, grouping, type = "centroid")
permutest_betadisper <- vegan::permutest(betadisper_model, permutations = 199)
mantel_model <- vegan::mantel(vegdist_bray, vegdist(varechem[, env_vars]), permutations = 199)
mantel_partial_model <- vegan::mantel.partial(vegdist_bray, vegdist(varechem[, env_vars]), vegdist(varechem[, env_vars[-1]]), permutations = 199)
protest_model <- vegan::protest(meta$points,
rda_sites_for_procrustes,
permutations = 199)
protest_ss <- as.numeric(protest_model$ss)[1]
protest_correlation <- sqrt(max(0, 1 - protest_ss))
protest_signif <- as.numeric(protest_model$signif)
anova_rda <- stats::anova(rda_model, permutations = 199)
permutest_rda <- vegan::permutest(rda_model, permutations = 199)
permutest_rda_tab <- permutest_rda$tab
if (is.null(permutest_rda_tab) || nrow(permutest_rda_tab) == 0) {
permutest_rda_tab <- data.frame(
Df       = permutest_rda$df,
Variance = permutest_rda$tot.chi,
F        = permutest_rda$f,
`Pr(>F)` = permutest_rda$signif,
row.names = "Model"
)
}
# Helper script to export vegan reference values for nuee comparison.
#
# Usage (from repo root in R):
#   source("tests/reference/export_vegan.R")
#
# The script writes a single RDS/JSON pair that captures representative
# outputs for the vegan functions mirrored in nuee. These payloads are
# consumed by the Python diagnostics to assert numerical compatibility.
library(vegan)
library(jsonlite)
setwd("C:/Users/parse01/documents-locaux/GitHub/nuee")
set.seed(123)
data(varespec)
data(varechem)
env_vars <- c("N", "P", "K", "Ca", "Mg")
grouping <- factor(ifelse(varechem$Humdepth > median(varechem$Humdepth),
"High", "Low"),
levels = c("Low", "High"))
matrix_payload <- function(mat) {
if (is.null(mat)) {
return(NULL)
}
m <- as.matrix(mat)
list(
data = unname(m),
rownames = if (!is.null(rownames(m))) as.character(rownames(m)) else NULL,
colnames = if (!is.null(colnames(m))) as.character(colnames(m)) else NULL
)
}
vector_payload <- function(vec) {
if (is.null(vec)) {
return(NULL)
}
vals <- unname(as.numeric(vec))
list(
data = vals,
names = if (!is.null(names(vec))) as.character(names(vec)) else NULL
)
}
dist_payload <- function(d) {
if (is.null(d)) {
return(NULL)
}
list(
data = unname(as.numeric(d)),
size = attr(d, "Size"),
labels = if (!is.null(attr(d, "Labels"))) as.character(attr(d, "Labels")) else NULL,
method = attr(d, "method")
)
}
table_payload <- function(tbl) {
if (is.null(tbl)) {
return(NULL)
}
df <- as.data.frame(tbl)
matrix_payload(df)
}
# Ordination -------------------------------------------------------------------
meta <- vegan::metaMDS(varespec, k = 2, distance = "bray",
trymax = 20, trace = FALSE)
rda_model <- vegan::rda(varespec, varechem[, env_vars])
cca_model <- vegan::cca(varespec, varechem[, env_vars])
pca_model <- stats::prcomp(varespec, center = TRUE, scale. = TRUE)
envfit_model <- vegan::envfit(meta, varechem[, env_vars], permutations = 199)
rda_sites_scaling1 <- scores(rda_model, display = "sites", scaling = 1)
rda_sites_for_procrustes <- rda_sites_scaling1[, seq_len(ncol(meta$points)), drop = FALSE]
procrustes_model <- vegan::procrustes(rda_sites_for_procrustes,
meta$points, symmetric = TRUE)
procrustes_summary <- summary(procrustes_model)
ordination_reference <- list(
metaMDS = list(
stress = meta$stress,
trymax = meta$trymax,
points = matrix_payload(meta$points),
species = matrix_payload(meta$species)
),
rda = list(
eigenvalues = list(
constrained = unname(rda_model$CCA$eig),
unconstrained = unname(rda_model$CA$eig)
),
bases = list(
cca_wa = matrix_payload(rda_model$CCA$wa),
ca_u = matrix_payload(rda_model$CA$u),
cca_v = matrix_payload(rda_model$CCA$v),
ca_v = matrix_payload(rda_model$CA$v)
),
weights = list(
row_sums = unname(rda_model$rowsum),
col_sums = unname(rda_model$colsum)
),
totals = list(
tot_chi = rda_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(rda_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(rda_model, display = "species", scaling = 3))
)
)
),
cca = list(
eigenvalues = list(
constrained = unname(cca_model$CCA$eig),
unconstrained = unname(cca_model$CA$eig)
),
bases = list(
cca_u = matrix_payload(cca_model$CCA$u),
cca_v = matrix_payload(cca_model$CCA$v),
cca_wa = matrix_payload(cca_model$CCA$wa),
ca_u = matrix_payload(cca_model$CA$u),
ca_v = matrix_payload(cca_model$CA$v)
),
totals = list(
tot_chi = cca_model$tot.chi
),
scores = list(
scaling1 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 1)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 1))
),
scaling2 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 2)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 2))
),
scaling3 = list(
sites = matrix_payload(vegan::scores(cca_model, display = "sites", scaling = 3)),
species = matrix_payload(vegan::scores(cca_model, display = "species", scaling = 3))
)
)
),
pca = list(
sdev = unname(pca_model$sdev),
rotation = matrix_payload(pca_model$rotation),
x = matrix_payload(pca_model$x),
center = unname(pca_model$center),
scale = unname(pca_model$scale)
),
envfit = list(
r = vector_payload(envfit_model$vectors$r),
r2 = vector_payload(envfit_model$vectors$r^2),
pvals = vector_payload(envfit_model$vectors$pvals),
scores = matrix_payload(scores(envfit_model, "vectors"))
),
procrustes = list(
correlation = unname(procrustes_summary$correlation),
ss = unname(procrustes_model$ss),
rotation = matrix_payload(procrustes_model$rotation),
translation = vector_payload(procrustes_model$translation)
)
)
# Dissimilarity & permutation ---------------------------------------------------
vegdist_bray <- vegan::vegdist(varespec, method = "bray")
adonis2_model <- vegan::adonis2(varespec ~ N + P + K + Ca + Mg,
data = varechem, permutations = 199)
anosim_model <- vegan::anosim(vegdist_bray, grouping, permutations = 199)
mrpp_model <- vegan::mrpp(varespec, grouping, permutations = 199)
betadisper_model <- vegan::betadisper(vegdist_bray, grouping, type = "centroid")
permutest_betadisper <- vegan::permutest(betadisper_model, permutations = 199)
mantel_model <- vegan::mantel(vegdist_bray, vegdist(varechem[, env_vars]), permutations = 199)
mantel_partial_model <- vegan::mantel.partial(vegdist_bray, vegdist(varechem[, env_vars]), vegdist(varechem[, env_vars[-1]]), permutations = 199)
protest_model <- vegan::protest(meta$points,
rda_sites_for_procrustes,
permutations = 199)
protest_ss <- as.numeric(protest_model$ss)[1]
protest_correlation <- sqrt(max(0, 1 - protest_ss))
protest_signif <- as.numeric(protest_model$signif)
anova_rda <- stats::anova(rda_model, permutations = 199)
permutest_rda <- vegan::permutest(rda_model, permutations = 199)
permutest_rda_tab <- permutest_rda$tab
if (is.null(permutest_rda_tab) || nrow(permutest_rda_tab) == 0) {
model_row <- data.frame(
Df = permutest_rda$df,
Variance = permutest_rda$tot.chi,
F = permutest_rda$f,
`Pr(>F)` = permutest_rda$signif,
row.names = "Model"
)
residual_row <- NULL
if (!is.null(permutest_rda$df.residual) && length(permutest_rda$df.residual) > 0) {
residual_row <- data.frame(
Df = permutest_rda$df.residual,
Variance = permutest_rda$res.chi,
F = NA_real_,
`Pr(>F)` = NA_real_,
row.names = "Residual"
)
}
permutest_rda_tab <- rbind(model_row, residual_row)
}
